<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sinya Loyalty v7.66 修復增強版</title>
  <style>
    :root{
      --primary:#0ea5e9;--secondary:#64748b;--danger:#ef4444;
      --bg:#f8fafc;--card:#ffffff;--border:#e5e7eb;--text:#111827;--muted:#6b7280;
    }
    *{box-sizing:border-box} body{margin:24px;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    h1{font-size:22px;margin:0 0 12px} h2{font-size:18px;margin:18px 0 8px}
    .section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    label{display:flex;flex-direction:column;font-size:12px;color:#374151}
    input,select,button{padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
    button{cursor:pointer;background:var(--primary);color:#fff;border:none}
    button.secondary{background:var(--secondary)} button.ghost{background:#fff;color:#111;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse} th,td{border:1px solid var(--border);padding:6px 8px;font-size:14px;text-align:right}
    th:first-child,td:first-child{text-align:center;width:56px}
    th{background:#f1f5f9;color:#334155} .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;padding:8px;background:#fff}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .outbox{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .value{font-weight:800;font-size:18px;margin-top:6px}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <h1>Sinya Loyalty v7.66 修復增強版</h1>

  <div class="section">
    <h2>設定與工具</h2>
    <div class="grid">
      <label>幣別符號<input id="curr_sym" placeholder="NT$"></label>
      <label>小數位數<input id="decimals" type="number" min="0" max="4" placeholder="0 或 2"></label>
    </div>
    <div class="toolbar">
      <button id="btn_save">💾 儲存</button>
      <button id="btn_load" class="secondary">⤓ 載入</button>
      <button id="btn_download" class="ghost">⬇ 下載設定(JSON)</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:8px;padding:0 8px;border-radius:10px;border:1px solid var(--border)">
        ⬆ 上傳設定(JSON) <input id="file_upload" type="file" accept="application/json">
      </label>
      <button id="btn_sample" class="ghost">✨ 填入示例數據</button>
      <button id="btn_check" class="ghost">🧪 恒等式檢測</button>
    </div>
  </div>

  <div class="section">
    <h2>一、基本參數</h2>
    <div class="grid">
      <label>毛利率 %（GM）<input id="gm" type="number" placeholder="20"></label>
      <label>現金占比 %<input id="pcash" type="number" placeholder="50"></label>
      <label>刷卡占比 %<input id="pcard" type="number" placeholder="50"></label>
      <label>刷卡費率 %<input id="cardfee" type="number" placeholder="1.8"></label>
      <label>其他固定行銷費（年）<input id="other_mkt" type="number" placeholder="300000"></label>
      <label class="note">uplift 使用「複利相乘」<input id="use_multiplicative" type="checkbox" checked></label>
    </div>
  </div>

  <div class="section">
    <h2>二、運費（可選）</h2>
    <div class="grid">
      <label>運送件數<input id="ship_count" type="number" placeholder="0"></label>
      <label>每件金額<input id="ship_unit" type="number" placeholder="0"></label>
    </div>
  </div>

  <div class="section">
    <h2>三、會員等級與購買回饋</h2>
    <div class="toolbar"><button id="btn_add_level">＋新增等級</button></div>
    <div class="table-wrap">
      <table id="tbl_levels">
        <thead>
          <tr><th>等級</th><th>人數</th><th>年均消費 ASP</th><th>現金回饋%</th><th>刷卡回饋%</th><th>刪除</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="grid" style="margin-top:8px">
      <label>會員人數（總，連動等級）<input id="members_total_auto" disabled placeholder="自動計算"></label>
    </div>
  </div>

  <div class="section">
    <h2>四、活動設定（uplift）</h2>
    <div class="toolbar"><button id="btn_add_campaign">＋新增活動</button></div>
    <div class="table-wrap">
      <table id="tbl_campaigns">
        <thead>
          <tr><th>#</th><th>uplift %</th><th>影響支付</th><th>活動成本</th><th>刪除</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="section">
    <h2>五、推薦（友薦）</h2>
    <div class="grid">
      <label>邀請人獎勵（元/單）<input id="ref_referrer" type="number" placeholder="50"></label>
      <label>被邀請人獎勵（元/單）<input id="ref_invitee" type="number" placeholder="30"></label>
      <label style="align-self:end;display:flex;gap:8px;align-items:center"><input id="ref_auto" type="checkbox"> 自動估算推薦訂單數（用漏斗）</label>
      <label>推薦訂單數（年）<input id="ref_orders" type="number" placeholder="手動輸入或勾自動"></label>
    </div>
    <div class="grid">
      <label>活躍率 %<input id="ref_active_rate" type="number" placeholder="30"></label>
      <label>每位活躍會員邀請數（次/年）<input id="ref_invites_per_active" type="number" placeholder="0.2"></label>
      <label>受邀接受率 %<input id="ref_accept_rate" type="number" placeholder="25"></label>
      <label>受邀者下單率 %<input id="ref_purchase_conv" type="number" placeholder="40"></label>
      <label>每位受邀者年均下單數<input id="ref_orders_per_invitee" type="number" placeholder="1.3"></label>
    </div>
    <p class="note">推薦訂單數 = 會員總數×活躍率×每位活躍會員邀請數×受邀接受率×受邀者下單率×每位受邀者年均下單數。</p>
  </div>

  <div class="section">
    <h2>六、操作</h2>
    <div class="toolbar">
      <button id="btn_calc">立即計算</button>
      <button id="btn_reset" class="secondary">重置</button>
      <button id="btn_save">儲存</button>
      <button id="btn_load" class="secondary">載入</button>
      <button id="btn_download" class="ghost">下載 JSON</button>
      <label class="ghost" style="display:inline-flex;align-items:center;gap:8px;padding:0 8px;border-radius:10px;border:1px solid var(--border)">
        上傳 JSON <input id="file_upload" type="file" accept="application/json">
      </label>
    </div>
  </div>

  <div class="section">
    <h2>七、年度匯總</h2>
    <div class="outbox">
      <div class="card"><div class="note">年 Sales（uplift 後合計）</div><div id="out_sales" class="value">-</div></div>
      <div class="card"><div class="note">年 GP</div><div id="out_gp" class="value">-</div></div>
      <div class="card"><div class="note">回饋（購買＋其他）</div><div id="out_rebates" class="value">-</div></div>
      <div class="card"><div class="note">刷卡費</div><div id="out_cardfee" class="value">-</div></div>
      <div class="card"><div class="note">活動成本（合計）</div><div id="out_campcost" class="value">-</div></div>
      <div class="card"><div class="note">其他固定行銷費</div><div id="out_other" class="value">-</div></div>
      <div class="card"><div class="note">運費</div><div id="out_ship" class="value">-</div></div>
      <div class="card"><div class="note">淨效益（Net）</div><div id="out_net" class="value">-</div></div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
