<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sinya Loyalty v7.66.3（年實際Sales=等級×ASP）</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<header>
  <h1>Sinya Loyalty v7.66.3</h1>
  <p>年度實際 Sales 由「四、會員等級與購買回饋」自動推導（Σ 等級人數 × ASP），不再手動輸入。</p>
</header>

<main>
  <!-- 核心參數 -->
  <section class="card">
    <h2>一、核心參數</h2>
    <div class="grid">
      <label>毛利率（GM%）<input id="gm" type="number" step="0.01" placeholder="20"></label>
      <label>現金付款占比（%）<input id="pcash" type="number" step="0.01" placeholder="50"></label>
      <label>刷卡付款占比（%）<input id="pcard" type="number" step="0.01" placeholder="50"></label>
      <label>刷卡手續費率（%）<input id="cardfee" type="number" step="0.01" placeholder="1.8"></label>
    </div>
    <p class="hint">占比會自動正規化為 100%。所有％以整數輸入，運算自動 ÷100。</p>
  </section>

  <!-- 年度目標與固定費（移除手動輸入的年度實際Sales） -->
  <section class="card">
    <h2>二、年度 KPI（目標 / 固定費）</h2>
    <div class="grid">
      <label>年度目標營收（含稅）<input id="sales_target" type="number" step="1" placeholder="12000000"></label>
      <label>年度目標毛利（GP 目標）<input id="gp_target" type="number" step="1" placeholder="300000"></label>
      <label>其他固定行銷費（年）<input id="other_mkt" type="number" step="1" placeholder="50000"></label>
    </div>
    <p class="hint">實際 Sales 由「四、會員等級與購買回饋」計算，不需手動輸入。</p>
  </section>

  <!-- 活動（年度層級 uplift） -->
  <section class="card">
    <h2>三、活動（年度層級 uplift%）</h2>
    <div class="table-wrap">
      <table id="tbl_campaigns">
        <thead>
        <tr>
          <th>名稱</th><th>uplift%</th><th>影響支付</th><th>成本</th><th>刪除</th>
        </tr>
        </thead>
        <tbody></tbody>
        <tfoot><tr><td colspan="5"><button id="add_campaign">＋新增活動</button></td></tr></tfoot>
      </table>
    </div>
    <p class="hint">uplift 合併計算（加總模型）：總乘數 = 1 + Σ(all) + Σ(cash) + Σ(card)。刷卡費基礎僅計入 Σ(all)+Σ(card)。</p>
  </section>

  <!-- 等級與購買回饋 -->
  <section class="card">
    <h2>四、會員等級與購買回饋</h2>
    <div class="table-wrap">
      <table id="tbl_levels">
        <thead>
        <tr>
          <th>等級</th><th>人數</th><th>年均消費 ASP</th><th>現金回饋%</th><th>刷卡回饋%</th><th>刪除</th>
        </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
        <tr><td colspan="6"><button id="add_level">＋新增等級</button></td></tr>
        </tfoot>
      </table>
    
    <!-- 會員人數總數（連動等級） -->
    <div class="grid" id="total_members_box" style="margin-top:8px">
      <label>會員人數（總，連動等級）
        <input id="members_total_auto" type="number" disabled placeholder="自動計算">
      </label>
    </div>
</div>
    <details>
      <summary>其他回饋（生日 / UGC / 推薦）</summary>
      <div class="grid">
        <label>生日回饋（每人）<input id="bday_amt" type="number" step="1" placeholder="100"></label>
        <label>生日參與率（%）<input id="bday_part" type="number" step="0.01" placeholder="10"></label>
        <label>總會員數（人）<input id="members_total" type="number" step="1" placeholder="1000"></label>
        <label>UGC（每月）<input id="ugc_month" type="number" step="1" placeholder="10000"></label>
        <label>推薦（邀請人/單）<input id="ref_referrer" type="number" step="1" placeholder="100"></label>
        <label>推薦（被邀請人/單）<input id="ref_invitee" type="number" step="1" placeholder="100"></label>
        <label>推薦訂單數（年）<input id="ref_orders" type="number" step="1" placeholder="50"></label>
      </div>
    </details>
  </section>

  <!-- 運費 -->
  <section class="card">
    <h2>五、運費</h2>
    <div class="grid">
      <label>件數（pcs）<input id="ship_count" type="number" step="1" placeholder="0"></label>
      <label>每件金額（含稅）<input id="ship_unit" type="number" step="1" placeholder="0"></label>
    </div>
    <p class="hint">運費 = 件數 × 每件金額（列入 Net 扣除）。</p>
  </section>

  <!-- 總結 -->
  <section class="card">
    <h2>六、總結結果（年度層級連動）</h2>
    <div class="results">
      <div><span>現金/刷卡占比（正規化）</span><strong id="norm_share">-</strong></div>
      <div><span>年 Sales（uplift 後合計）</span><strong id="out_sales">-</strong></div>
      <div><span>年 GP</span><strong id="out_gp">-</strong></div>
      <div><span>回饋（購買＋生日＋UGC＋推薦）</span><strong id="out_rebate">-</strong></div>
      <div><span>刷卡費</span><strong id="out_cardfee">-</strong></div>
      <div><span>活動成本（合計）</span><strong id="out_campaign">-</strong></div>
      <div><span>其他固定行銷費</span><strong id="out_othermkt">-</strong></div>
      <div><span>運費</span><strong id="out_shipping">-</strong></div>
      <div class="net"><span>淨效益（Net）</span><strong id="out_net">-</strong></div>
      <div><span>營收達成率</span><strong id="out_sales_attain">-</strong></div>
      <div><span>Net / 目標毛利</span><strong id="out_net_vs_gptarget">-</strong></div>
    </div>
    <div class="actions">
      <button id="btn_calc">立即計算</button>
      <button id="btn_reset" class="ghost">重置</button>
      <label class="chk"><input type="checkbox" id="use_multiplicative"> uplift 使用「複利相乘」</label>
    </div>
    <p class="hint small">恒等式自檢：GP ?= Net + 回饋 + 刷卡費 + 活動 + 其他行銷 + 運費（若不平衡會在 Console 顯示差額）。</p>
  </section>
</main>

<footer><p>© 2025 Sinya Loyalty v7.66.3</p></footer>

<script src="app.js"></script>

<!-- === Persistence Inline Script (auto-save / load / import / export) === -->
<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  const STORE_KEY = 'sinya_loyalty_state_v1';
  const $ = (sel, root=document)=> root.querySelector(sel);
  const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));

  function collectState(){
    const inputs=$$('input'), selects=$$('select');
    return {
      inputs: inputs.map((el,i)=>({id:el.id||'__i'+i, name:el.name||'', placeholder:el.placeholder||'', type:el.type||'', value: el.type==='checkbox'? el.checked : el.value})),
      selects: selects.map((el,i)=>({id:el.id||'__s'+i, name:el.name||'', value:el.value}))
    };
  }
  function applyState(state){
    try{
      (state.inputs||[]).forEach(it=>{
        let el=document.getElementById(it.id) || $$('input[name="'+CSS.escape(it.name)+'"]')[0] || $$('input[placeholder="'+CSS.escape(it.placeholder)+'"]')[0];
        if(!el) return;
        if((it.type||'')==='checkbox') el.checked=!!it.value; else el.value=it.value;
        el.dispatchEvent(new Event('input',{bubbles:true}));
        el.dispatchEvent(new Event('change',{bubbles:true}));
      });
      (state.selects||[]).forEach(it=>{
        let el=document.getElementById(it.id) || $$('select[name="'+CSS.escape(it.name)+'"]')[0];
        if(!el) return; el.value=it.value; el.dispatchEvent(new Event('change',{bubbles:true}));
      });
    }catch(e){ console.error('[Persist] applyState', e); }
  }
  function toast(msg, err){
    let t=document.getElementById('_persist_toast'); if(!t){ t=document.createElement('div'); t.id='_persist_toast';
      t.style.cssText='position:fixed;right:16px;bottom:16px;background:#0b1020;color:#fff;border:1px solid #334155;border-radius:12px;padding:10px 12px;z-index:999999;font:14px system-ui'; document.body.appendChild(t); }
    t.textContent=msg; t.style.borderColor=err?'#ef4444':'#334155'; t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none',2000);
  }
  function saveLocal(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(collectState())); toast('已儲存'); }catch(e){ console.error(e); toast('儲存失敗',1); } }
  function loadLocal(){ try{ const raw=localStorage.getItem(STORE_KEY); if(!raw) return toast('無可載入資料'); applyState(JSON.parse(raw)); toast('已載入'); }catch(e){ console.error(e); toast('載入失敗',1); } }
  function exportJSON(){ try{ const blob=new Blob([JSON.stringify(collectState(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sinya-loyalty-state.json'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),3000);}catch(e){ console.error(e); toast('匯出失敗',1); } }
  function importJSON(file){ const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); applyState(data); localStorage.setItem(STORE_KEY, JSON.stringify(data)); toast('匯入成功'); }catch(e){ console.error(e); toast('匯入失敗',1);} }; r.readAsText(file); }

  function addUI(){
    if(document.getElementById('_persist_bar')) return;
    const bar=document.createElement('div'); bar.id='_persist_bar';
    bar.style.cssText='display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px';
    bar.innerHTML = `
      <button id="_sav" style="background:#2563eb;border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer">儲存</button>
      <button id="_lod" style="background:#334155;border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer">載入</button>
      <button id="_exp" style="background:#334155;border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer">匯出 JSON</button>
      <label style="display:inline-flex;align-items:center;gap:6px;background:#0b1020;border:1px solid #334155;color:#e5e7eb;border-radius:10px;padding:6px 10px;cursor:pointer">
        匯入 JSON<input id="_imp" type="file" accept=".json" style="display:none">
      </label>
      <label style="display:inline-flex;align-items:center;gap:6px;opacity:.85">
        <input id="_autosave" type="checkbox" checked> 自動儲存
      </label>`;
    const anchor=document.querySelector('.actions')||document.querySelector('footer')||document.body;
    anchor.parentNode.insertBefore(bar, anchor.nextSibling);
    document.getElementById('_sav').onclick=saveLocal;
    document.getElementById('_lod').onclick=loadLocal;
    document.getElementById('_exp').onclick=exportJSON;
    document.getElementById('_imp').addEventListener('change', e=>{ const f=e.target.files&&e.target.files[0]; if(f) importJSON(f); e.target.value=''; });
    const autosave=document.getElementById('_autosave'), handler=()=>{ if(autosave.checked) saveLocal(); };
    document.addEventListener('input', handler, true);
    document.addEventListener('change', handler, true);
  }

  (document.readyState!=='loading' ? addUI : document.addEventListener('DOMContentLoaded', addUI));
  try{ const raw=localStorage.getItem(STORE_KEY); if(raw) applyState(JSON.parse(raw)); }catch(e){}
})();
</script>
<!-- === /Persistence Inline Script === -->

</body>
</html>
